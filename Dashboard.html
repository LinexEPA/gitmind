<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸŒ¸ è­·ç†è‡¨åºŠæ¨ç†çœ‹æ¿</title>
<style>
  body{margin:0;padding:20px;background:linear-gradient(180deg,#fff5f7,#f4fbff);
       font-family:ui-rounded,"PingFang TC","Noto Sans TC",system-ui,-apple-system,sans-serif;color:#2b2f36}
  h1{font-size:22px;margin:0 0 12px;text-align:center}
  .card{max-width:560px;margin:0 auto;background:#fff;border-radius:18px;border:2px solid #ffe0ec;
        box-shadow:0 12px 22px rgba(255,160,190,.18);padding:14px}
  .title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .pill{font-size:13px;padding:6px 12px;border-radius:999px;background:linear-gradient(90deg,#ffd9ec,#c7eeff);border:1px solid #ffd9ec}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .cell{min-height:78px;border:1px dashed #e6e8ee;border-radius:12px;background:#fffafd;
        display:flex;align-items:center;justify-content:center;text-align:center;padding:10px;font-size:18px;line-height:1.2}
  .center{background:linear-gradient(180deg,#fff1f7,#eef9ff);border:2px solid #ff9ac2;font-weight:700}
  .muted{color:#7a7f87;font-size:13px;text-align:center;margin-top:8px}
  .empty{color:#9aa0a6;text-align:center;padding:24px 8px}
  .bar{max-width:560px;margin:10px auto 0;text-align:center}
  .btn{display:inline-block;margin:6px;background:#4b7bec;color:#fff;border:0;border-radius:10px;font-size:14px;padding:8px 12px;cursor:pointer}
</style>
</head>
<body>
  <h1 id="h1">ğŸŒ¸ ä¹å®®æ ¼çœ‹æ¿</h1>
  <div class="card">
    <div class="title">
      <span class="pill" id="topicPill">ä¸»é¡Œ</span>
      <span class="pill" id="groupPill">çµ„åˆ¥</span>
    </div>
    <div id="content">
      <div class="grid" id="grid"></div>
      <div class="muted">æ­¤é æ¯ 5 ç§’è‡ªå‹•æ›´æ–°ã€‚</div>
    </div>
  </div>

  <div class="bar">
    <button id="refreshBtn" class="btn">â†» ç«‹å³æ›´æ–°</button>
  </div>

<script>
  // â›³ æ›æˆä½ çš„ Apps Script /execï¼ˆèˆ‡ index.html åŒä¸€æ¢ï¼‰
  const API_URL = 'https://script.google.com/macros/s/AKfycbxo0KhEWoVMpfATaF760teggaREGWtaAoCAfPc039fpHTAjVSID7e-nUyl8Npi2yDhQ/exec';

  const sp = new URLSearchParams(location.search);
  const topic = sp.get('topic') || 'æœªå‘½åä¸»é¡Œ';
  const group = sp.get('group') || '1';

  document.getElementById('h1').textContent = `ğŸŒ¸ è­·ç†è‡¨åºŠæ¨ç†çœ‹æ¿ï¼š${topic}`;
  document.getElementById('topicPill').textContent = `ä¸»é¡Œï¼š${topic}`;
  document.getElementById('groupPill').textContent = `çµ„åˆ¥ï¼š${group}`;

  const gridEl = document.getElementById('grid');
  const contentEl = document.getElementById('content');

  // JSONPï¼ˆé¿å… CORSï¼‰
  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb='cb_'+Date.now()+'_'+Math.floor(Math.random()*1000);
      const s=document.createElement('script');
      window[cb]=(data)=>{ resolve(data); delete window[cb]; s.remove(); };
      s.onerror=()=>{ reject(new Error('JSONP è¼‰å…¥å¤±æ•—')); delete window[cb]; s.remove(); };
      s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
      document.body.appendChild(s);
    });
  }

  function cell(txt, center=false){
    const d=document.createElement('div');
    d.className='cell'+(center?' center':'');
    d.textContent = center ? `ğŸ¯ ${topic}` : (txt||'');
    return d;
  }

  function showEmpty(){
    contentEl.innerHTML = `<div class="empty">ç›®å‰å°šç„¡è³‡æ–™ï¼ˆä¸»é¡Œã€Œ${topic}ã€ç¬¬ ${group} çµ„ï¼‰ã€‚<br>è«‹åŒçµ„åœ¨å›å¡«é é€å‡ºå¾Œå†è©¦ä¸€æ¬¡ã€‚</div>`;
  }

  async function load(){
    try{
      // âœ… å¸¶ä¸Š strict=1ï¼Œå¾Œç«¯å°±ä¸æœƒç”¨ã€Œåªçœ‹ groupã€çš„é€€ä¸€æ­¥é‚è¼¯
      const url = `${API_URL}?action=getLatestGrid&topic=${encodeURIComponent(topic)}&group=${encodeURIComponent(group)}&strict=1`;
      const res = await jsonp(url); // { ok:true, grid:[...] }
      const cells = (res && res.ok && Array.isArray(res.grid)) ? res.grid : [];
      const isAllEmpty = cells.length===9 && cells.every(v => (v===null || v===undefined || String(v).trim()===''));
      if (cells.length!==9 || isAllEmpty){
        showEmpty();
        return;
      }
      // æœ‰è³‡æ–™ â†’ æ¸²æŸ“ä¹å®®æ ¼
      contentEl.innerHTML = `<div class="grid" id="grid"></div><div class="muted">æ­¤é æ¯ 5 ç§’è‡ªå‹•æ›´æ–°ã€‚</div>`;
      const g = document.getElementById('grid');
      for (let i=0;i<9;i++) g.appendChild(cell(i===4 ? `ğŸ¯ ${topic}` : (cells[i]||''), i===4));
    }catch(e){
      console.error(e);
    }
  }

  load();
  const timer = setInterval(load, 5000);
  document.getElementById('refreshBtn').addEventListener('click', load);
  window.addEventListener('beforeunload', ()=>clearInterval(timer));
</script>
</body>
</html>

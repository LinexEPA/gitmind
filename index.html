<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title> è­·ç†è‡¨åºŠæ¨ç†ï¼ˆä¸€èµ·ä¾†è³“æœï¼‰</title>
<style>
  :root{
    --bg1:#fff5f9; --bg2:#f4fbff; --card:#ffffff; --ink:#2b2f36;
    --muted:#6b7280; --accent:#ff9ac2; --grid:#e9e9ef; --btn:#4b7bec;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);
       font-family:ui-rounded,"PingFang TC","Noto Sans TC",system-ui,-apple-system,sans-serif;}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  h1{font-size:22px;margin:4px 0 12px}
  .card{background:var(--card);border:2px solid #ffe2ef;border-radius:16px;
        box-shadow:0 10px 20px rgba(255,160,190,.18);padding:12px 12px 16px;margin-bottom:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .pill{display:inline-block;padding:6px 12px;border-radius:999px;
        background:linear-gradient(90deg,#ffd9ec,#c7eeff);border:1px solid #ffd9ec;font-size:13px}
  select{font-size:16px;padding:8px 10px;border-radius:10px;border:1px solid #dfe3ea;background:#fff}
  .badge{background:#fff;border:1px solid #ffd9ea;padding:8px 10px;border-radius:10px;font-size:14px}
  .groups{display:flex;gap:8px;flex-wrap:wrap}
  .gbtn{flex:1;min-width:76px;text-align:center;padding:10px 0;border-radius:12px;
        border:2px solid #dfe7ff;background:#fff;font-size:16px}
  .gbtn.active{background:#e6f0ff;border-color:#bcd3ff}
  .hint{color:var(--muted);font-size:14px;margin:8px 2px 12px}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:640px){.grid{grid-template-columns:repeat(3,1fr);}}
  textarea{width:100%;min-height:86px;padding:10px;font-size:16px;border-radius:12px;border:1px solid var(--grid)}
  .btn{display:inline-block;margin-top:14px;background:var(--btn);color:#fff;border:0;border-radius:12px;
       font-size:18px;padding:14px 18px;width:100%}
  .btn[disabled]{opacity:.5}
  .toast{margin-top:10px;font-size:15px}
  .ok{color:#2f9e44}.err{color:#c92a2a}
  .link{display:block;text-align:center;margin-top:10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸŒ¸ è­·ç†è‡¨åºŠæ¨ç†ï¼ˆä¸€èµ·ä¾†è³“æœï¼‰</h1>

  <div class="card">
    <div class="row">
      <span class="pill">ä¸»é¡Œ</span>
      <select id="topicSelect">
        <option value="">è«‹é¸æ“‡ä¸»é¡Œ</option>
        <option>è¡€ç³–ç›£æ¸¬</option>
        <option>è¼¸è¡€</option>
        <option>åˆ©å°¿åŠ‘</option>
        <option>æŠ—ç”Ÿç´ </option>
        <option>æ°§æ°£</option>
      </select>
      <span id="topicBadge" class="badge" style="display:none"></span>
    </div>
    <div class="row">
      <span class="pill">çµ„åˆ¥</span>
      <span id="groupLabel" class="badge">æœªé¸æ“‡</span>
    </div>
    <div class="groups" id="groupBtns"></div>
  </div>

  <div class="hint">å¡«å¯«é †åºï¼šæœƒæ˜¯ <b>è¢å¹•ä¸Šçœ‹åˆ°çš„ä¹å®®æ ¼ç•«é¢</b>å–”ï½</div>

  <div class="grid">
    <textarea id="a1"  placeholder="a1"></textarea>
    <textarea id="a2"  placeholder="a2"></textarea>
    <textarea id="a3"  placeholder="a3"></textarea>
    <textarea id="a4"  placeholder="a4"></textarea>
    <textarea id="a5"  placeholder="å¡«ä¸Šå°çµ„çš„é¡Œç›®"></textarea>
    <textarea id="a6"  placeholder="a6"></textarea>
    <textarea id="a7"  placeholder="a7"></textarea>
    <textarea id="a8"  placeholder="a8"></textarea>
    <textarea id="a9"  placeholder="a9"></textarea>
  </div>

  <button id="submitBtn" class="btn" disabled>é€å‡º</button>
  <a id="goBoard" class="link" target="_blank" rel="noopener">ğŸ‘‰ é€å‡ºå¾Œé–‹å•Ÿçœ‹æ¿</a>
  <div id="toast" class="toast"></div>

  <div class="hint">å°æé†’ï¼šæ¯æ ¼å¡«å…¥ 1å€‹è­·ç†è‡¨åºŠé—œéµå³å¯ã€‚</div>
</div>

<script>
  // â‘  æŠŠé€™è£¡æ›æˆä½ éƒ¨ç½²å¥½çš„ Apps Script Web App /execï¼ˆåŒä¸€æ”¯ï¼Œå¯«å…¥èˆ‡è®€å–éƒ½åœ¨é€™è£¡ï¼‰
  const API_URL = 'https://script.google.com/macros/s/AKfycbzk19tD47ulOi8N9FGQSBbecd2n3_pAbtcsEKeW05-zfH0g2KyaR5_CTksbsh3Lh4Gt/exec';

  // è®€ URL é è¨­å€¼ï¼ˆå¯ç”¨ ?topic=...&group=... é å…ˆå¸¶å…¥ï¼‰
  const sp = new URLSearchParams(location.search);
  let topic = sp.get('topic') || '';
  let group_id = sp.get('group') || '';

  // å…ƒä»¶
  const sel   = document.getElementById('topicSelect');
  const badge = document.getElementById('topicBadge');
  const groupLabel = document.getElementById('groupLabel');
  const groupBtns  = document.getElementById('groupBtns');
  const submitBtn  = document.getElementById('submitBtn');
  const toast      = document.getElementById('toast');
  const goBoard    = document.getElementById('goBoard');

  // ä¸»é¡Œ UIï¼šè‹¥ç¶²å€å¸¶äº† topicï¼Œå°±é–å®šé¡¯ç¤ºï¼›å¦å‰‡å¯é¸
  function initTopicUI(){
    if (topic) {
      sel.style.display = 'none';
      badge.style.display = 'inline-block';
      badge.textContent = topic;
      sel.value = topic;
    } else {
      badge.style.display = 'none';
      sel.addEventListener('change', () => {
        topic = sel.value;
        updateReady();
        goBoard.href = `Dashboard.html?topic=${encodeURIComponent(topic)}&group=${encodeURIComponent(group_id||'1')}`;
      });
    }
  }

  // å»ºç«‹ 1~5 çµ„æŒ‰éˆ•
  for (let i=1;i<=5;i++){
    const b = document.createElement('button');
    b.type='button'; b.className='gbtn'; b.textContent=`ç¬¬ ${i} çµ„`;
    if (group_id==i.toString()) b.classList.add('active');
    b.addEventListener('click', ()=>{
      group_id = String(i);
      [...groupBtns.children].forEach(c=>c.classList.remove('active'));
      b.classList.add('active');
      groupLabel.textContent = `ç¬¬ ${group_id} çµ„`;
      updateReady();
      goBoard.href = `Dashboard.html?topic=${encodeURIComponent(topic||sel.value)}&group=${encodeURIComponent(group_id)}`;
    });
    groupBtns.appendChild(b);
  }

  function updateReady(){
    const t = topic || sel.value;
    submitBtn.disabled = !(t && group_id);
  }

  // é€å‡ºï¼ˆç”¨ FormData + no-corsï¼šé¿å…ç€è¦½å™¨é æª¢ CORSï¼‰
  submitBtn.addEventListener('click', async ()=>{
    const t = topic || sel.value;
    if (!t || !group_id){ toast.innerHTML='<span class="err">è«‹å…ˆé¸ä¸»é¡Œèˆ‡çµ„åˆ¥</span>'; return; }

    const cells = [];
    for (let i=1;i<=9;i++){ cells.push(document.getElementById('a'+i).value.trim()); }

    try {
      submitBtn.disabled = true;
      toast.textContent = 'é€å‡ºä¸­â€¦';

      const fd = new FormData();
      fd.append('action','submitGrid');
      fd.append('topic', t);
      fd.append('group_id', group_id);
      for (let i=1;i<=9;i++) fd.append('a'+i, cells[i-1]);

      // ä¸è¨­å®š headersã€ä½¿ç”¨ no-corsï¼Œè®“ç€è¦½å™¨ç›´æ¥é€å‡º
      await fetch(API_URL, { method:'POST', body: fd, mode:'no-cors' });

      toast.innerHTML = '<span class="ok">é€å‡ºæˆåŠŸï¼è«‹åˆ‡åˆ°çœ‹æ¿é æŸ¥çœ‹ã€‚</span>';
      goBoard.href = `Dashboard.html?topic=${encodeURIComponent(t)}&group=${encodeURIComponent(group_id)}`;
    } catch (err) {
      toast.innerHTML = `<span class="err">éŒ¯èª¤ï¼š${err.message}</span>`;
    } finally {
      submitBtn.disabled = false;
    }
  });

  initTopicUI();
  groupLabel.textContent = group_id ? `ç¬¬ ${group_id} çµ„` : 'æœªé¸æ“‡';
  updateReady();
</script>
</body>
</html>
